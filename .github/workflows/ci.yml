name: PlatformIO CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build (PlatformIO)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install -U platformio

      - name: Install project libraries
        run: |
          pio lib install

      - name: Disable LVGL Helium assembly for ESP32-P4 (if present)
        run: |
          f=.pio/libdeps/esp32p4_pioarduino/lvgl/src/draw/sw/blend/helium/lv_blend_helium.S
          if [ -f "$f" ]; then
            mv "$f" "$f.disabled"
            echo "Renamed $f -> $f.disabled"
          else
            echo "No Helium assembly found to disable"
          fi

      - name: Build with PlatformIO
        run: |
          pio run -e esp32p4_pioarduino